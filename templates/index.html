<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Pipeline de Procesamiento de Videos</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
	body {
	  background-color: #f8f9fa;
	  font-family: 'Inter', sans-serif;
	}

	h1, h4, h5 {
	  font-weight: 600;
	}

	/* Pasos del pipeline */
	.pipeline-step {
	  display: inline-block;
	  padding: 10px 20px;
	  margin: 5px;
	  color: white;
	  font-weight: 500;
	  min-width: 180px;
	  text-align: center;
	  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
	  transition: all 0.3s ease-in-out;
	  margin-left: 4%;
	}
	.pipeline-step.inactive {
	  background-color: #b0b0b0;
	  opacity: 0.6;
	}
	.pipeline-step.active {
	  background: linear-gradient(135deg, #007bff, #00bfff);
	  transform: scale(1.05);
	  box-shadow: 0 4px 10px rgba(0,123,255,0.4);
	}
	.pipeline-step.completed {
	  background: linear-gradient(135deg, #28a745, #5cd65c);
	}
	.pipeline-step.completed::after {
	  content: " âœ“";
	  font-weight: bold;
	}

	/* Tabla */
	.table th {
	  background-color: #343a40;
	  color: white;
	}

	/* Estados */
	.status-success {
	  color: #28a745;
	  font-weight: bold;
	}
	.status-error {
	  color: #dc3545;
	  font-weight: bold;
	}

	/* BotÃ³n custom de archivo */
	.custom-file-upload {
	  background: linear-gradient(135deg, #4e8ef7, #1c5adf);
	  color: white;
	  padding: 10px 16px;
	  border-radius: 8px;
	  cursor: pointer;
	  font-weight: bold;
	  transition: 0.3s;
	  display: inline-block;
	  margin-right: 8px;
	}
	.custom-file-upload:hover {
	  background: linear-gradient(135deg, #1c5adf, #4e8ef7);
	}

	/* BotÃ³n de subir */
	#upload-btn {
	  background: #00b894;
	  border: none;
	  border-radius: 8px;
	  padding: 10px 16px;
	  color: #fff;
	  font-weight: 500;
	  transition: background 0.3s;
	}
	#upload-btn:hover {
	  background: #019874;
	}

	/* Spinner */
	.spinner {
	  width: 18px;
	  height: 18px;
	  border: 3px solid #f3f3f3;
	  border-top: 3px solid #4e8ef7;
	  border-radius: 50%;
	  animation: spin 0.7s linear infinite;
	  display: inline-block;
	  vertical-align: middle;
	  margin-right: 6px;
	}
	@keyframes spin {
	  to { transform: rotate(360deg); }
	}

	/* Barra de progreso personalizada */
	.progress-bar {
	  background: #e9ecef;
	  border-radius: 4px;
	  overflow: hidden;
	  display: inline-block;
	  vertical-align: middle;
	  width: 150px;
	  margin-left: 8px;
	}
	.progress-bar div {
	  height: 6px;
	  background: linear-gradient(135deg, #007bff, #00bfff);
	  width: 0%;
	  transition: width 0.3s ease;
	}

	/* Icono de estado */
	#statusIcon {
	  transition: transform 0.3s ease;
	}
	#statusIcon:hover {
	  transform: rotate(15deg) scale(1.2);
	}

	/* LÃ­nea del log */
	#logLine {
	  font-family: monospace;
	  font-size: 0.95em;
	  color: #333;
	}
	
	#estado-procesamiento td {
	  font-weight: 500;
	  color: #343a40;
	}
  </style>
</head>
<body>
<div class="container mt-5">
	<h1 class="text-center mb-4" style="font-weight:700; color:#343a40;">
	  ğŸ¬ Pipeline de Procesamiento de Videos
	</h1>

    <!-- Entrada de carpeta/ruta -->
	<div class="card shadow-sm mb-4">
	  <div class="card-body">
		<h5 class="card-title">ğŸ“‚ Procesar desde carpeta</h5>
		<div class="form-group">
		  <label for="folderPath">Ruta de carpeta o archivo:</label>
		  <input type="text" id="folderPath" class="form-control" placeholder="/ruta/a/carpeta/o/archivo"/>
		</div>
		<button id="startProcessing" class="btn btn-outline-primary">Iniciar Procesamiento</button>
	  </div>
	</div>

  <!-- Formulario de subida directa -->
	<div class="card shadow-sm mb-4">
	  <div class="card-body">
		<h5 class="card-title">ğŸ“¤ Subir archivo de video</h5>
		<form id="upload-form">
		  <label for="video-input" class="custom-file-upload">
			<i class="fas fa-file-upload"></i> Elegir archivo
		  </label>
		  <input type="file" id="video-input" name="video" accept=".mkv,.mp4,.avi,.mov,.flv,.wmv" required style="display:none" />
		  <button type="submit" id="upload-btn" class="btn btn-success ml-2">Subir</button>
		</form>
		<div id="upload-status" class="mt-3" style="display:none;">
		  <span class="spinner"></span>
		  <span id="status-text">Preparando subidaâ€¦</span>
		  <div class="progress-bar"><div></div></div>
		  <span id="upload-percent">0%</span>
		</div>
	  </div>
	</div>

	<div class="card shadow-sm mb-4">
	  <div class="card-body">
		<h5 class="card-title">ğŸ› ï¸ Estado del Pipeline</h5>
		<div id="pipelineSteps" class="d-flex flex-wrap">
		  <div id="step1" class="pipeline-step inactive">Reparar Archivo</div>
		  <div id="step2" class="pipeline-step inactive">Reducir TamaÃ±o</div>
		  <div id="step3" class="pipeline-step inactive">Optimizar Video</div>
		  <div id="step4" class="pipeline-step inactive">Validar DuraciÃ³n</div>
		</div>
	  </div>
	</div>
	
	<div class="card shadow-sm mb-4" id="estado-procesamiento">
	  <div class="card-body">
		<div class="d-flex justify-content-between align-items-center">
		  <h5 class="mb-0">ğŸ“ˆ Estado de procesamiento</h5>
		  <span id="statusIcon" style="font-size:1.5em;">ğŸŸ¢</span>
		</div>
		<p class="mt-2 mb-1"><strong>Archivo en proceso:</strong> <span id="currentFile">Ninguno</span></p>

		<table class="table table-sm table-bordered text-center mt-3">
		  <thead class="thead-light">
			<tr>
			  <th>Frames</th>
			  <th>FPS</th>
			  <th>DuraciÃ³n</th>
			  <th>Bitrate</th>
			  <th>Velocidad</th>
			</tr>
		  </thead>
		  <tbody>
			<tr>
			  <td id="stat-frames">â€“</td>
			  <td id="stat-fps">â€“</td>
			  <td id="stat-time">â€“</td>
			  <td id="stat-bitrate">â€“</td>
			  <td id="stat-speed">â€“</td>
			</tr>
		  </tbody>
		</table>
		
		<div class="mt-3">
		  <h6 class="text-muted">ğŸ¬ InformaciÃ³n del vÃ­deo original</h6>
			<table class="table table-sm table-striped table-bordered mt-2">
			  <thead class="thead-light">
				<tr><th>Campo</th><th>Valor</th></tr>
			  </thead>
			  <tbody>
				<tr><td>Nombre</td><td id="info-name">â€“</td></tr>
				<tr><td>DuraciÃ³n</td><td id="info-duration">â€“</td></tr>
				<tr><td>ResoluciÃ³n</td><td id="info-resolution">â€“</td></tr>
				<tr><td>Formato</td><td id="info-format">â€“</td></tr>
				<tr><td>Codec vÃ­deo</td><td id="info-vcodec">â€“</td></tr>
				<tr><td>Codec audio</td><td id="info-acodec">â€“</td></tr>
				<tr><td>TamaÃ±o</td><td id="info-size">â€“</td></tr>
			  </tbody>
			</table>
		</div>
	  </div>
	</div>

	<div class="card shadow-sm mb-4">
	  <div class="card-body">
		<h5 class="card-title">ğŸ“š Historial de Procesamiento</h5>
		<table class="table table-hover">
		  <thead class="thead-dark">
			<tr><th>Nombre del Video</th><th>Estado</th></tr>
		  </thead>
		  <tbody id="history"></tbody>
		</table>
	  </div>
	</div>


<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>

<script>
$(document).ready(function() {
  
  // Variables de estado
  let lastLogHash = "";
  let isProcessing = false;
  
  // --- Lanzar procesamiento por ruta ---
  $('#startProcessing').click(function() {
    const folderPath = $('#folderPath').val().trim();
    if (!folderPath) {
      alert('Por favor, introduce una ruta vÃ¡lida.');
      return;
    }
    
    // Resetear interfaz
    resetUI();
    isProcessing = true;
    
    $.ajax({
      url: '/process',
      type: 'POST',
      contentType: 'application/json',
      data: JSON.stringify({ folder: folderPath }),
      success: function(resp) {
        console.log('Procesamiento iniciado:', resp.message);
      },
      error: function(xhr) {
        console.error('Error:', xhr.responseJSON.error);
        alert('Error: ' + xhr.responseJSON.error);
        isProcessing = false;
      }
    });
  });
  
  // --- Subida de archivo ---
  $('#upload-form').on('submit', function(e) {
    e.preventDefault();
    if ($('#video-input')[0].files.length === 0) {
      alert('Selecciona un archivo primero.');
      return;
    }
    
    $('#upload-status').fadeIn();
    $('.progress-bar div').css('width', '0%');
    $('#upload-percent').text('0%');
    
    // SimulaciÃ³n de subida
    simulateUpload();
  });

  // FunciÃ³n para resetear UI
  function resetUI() {
    $('#stat-frames').text('â€“');
    $('#stat-fps').text('â€“');
    $('#stat-time').text('â€“');
    $('#stat-bitrate').text('â€“');
    $('#stat-speed').text('â€“');
    lastLogHash = "";
  }

  // SimulaciÃ³n de subida
  function simulateUpload() {
    let progress = 0;
    const interval = setInterval(() => {
      progress += 5;
      $('.progress-bar div').css('width', progress + '%');
      $('#upload-percent').text(progress + '%');
      
      if (progress >= 100) {
        clearInterval(interval);
        setTimeout(() => {
          $('#upload-status').fadeOut();
          alert('Archivo subido correctamente (simulaciÃ³n)\nUsa la ruta para procesar.');
        }, 500);
      }
    }, 200);
  }

  // FunciÃ³n para extraer datos del log
function parseLogLine(logLine) {
    const data = {
        frames: 'â€“',
        fps: 'â€“',
        time: 'â€“',
        bitrate: 'â€“',
        speed: 'â€“'
    };

    if (!logLine) return data;

    console.log('Parseando log:', logLine);

    // 1. INTENTAR FORMATO GStreamer: "progressreport0 (00:01:25): 101 / 139 seconds (72,7 %)"
    const gstMatch = logLine.match(/progressreport.*\((\d+:\d+:\d+)\):\s*(\d+)\s*\/\s*(\d+)\s*seconds\s*\(([\d,]+)\s*%\)/);
    
    if (gstMatch) {
        const currentTime = gstMatch[1];      // 00:01:25
        const secondsProcessed = parseInt(gstMatch[2]); // 101 segundos procesados
        const totalSeconds = parseInt(gstMatch[3]);     // 139 segundos totales
        const percentage = gstMatch[4].replace(',', '.'); // 72,7 -> 72.7
        
        // CALCULAR FPS (asumiendo 25 fps estÃ¡ndar)
        const fps = 25; // Valor por defecto
        const framesProcessed = secondsProcessed * fps;
        const totalFrames = totalSeconds * fps;
        
        // Mapear a campos
        data.time = currentTime;
        data.frames = Math.round(framesProcessed) + " / " + Math.round(totalFrames); // Ej: "2525 / 3475"
        data.fps = fps + " fps"; // Valor fijo o calculado
        data.bitrate = percentage + '%';
        
        return data;
    }

    // 2. FORMATO FFmpeg (original)
    const keyValuePairs = {};
    const regex = /(\w+)=([^=\s]+(?:\s[^=\s]+)*?)(?=\s+\w+=|$)/g;
    let match;
    
    while ((match = regex.exec(logLine)) !== null) {
        keyValuePairs[match[1].toLowerCase()] = match[2].trim();
    }

    // Mapeo ORIGINAL
    if (keyValuePairs.frame || keyValuePairs.frames) {
        data.frames = keyValuePairs.frame || keyValuePairs.frames || 'â€“';
    }
    
    if (keyValuePairs.fps) {
        data.fps = keyValuePairs.fps;
    }
    
    if (keyValuePairs.time) {
        const timeMatch = keyValuePairs.time.match(/^(\d+:\d+:\d+)/);
        data.time = timeMatch ? timeMatch[1] : keyValuePairs.time;
    }
    
    if (keyValuePairs.bitrate) {
        data.bitrate = keyValuePairs.bitrate;
    }
    
    if (keyValuePairs.speed) {
        data.speed = keyValuePairs.speed;
    }

    return data;
}

  // --- ActualizaciÃ³n de estado ---
  function updateStatus() {
    $.getJSON('/status')
      .done(function(data) {
        try {
          // Actualizar archivo en proceso
          const currentFile = data.current_file || 'Ninguno';
          $('#currentFile').text(currentFile);
          
          // Actualizar pasos del pipeline
          updateSteps(data.current_step || 0);
          
          // Actualizar informaciÃ³n del video
          updateVideoInfo(data.video_info || {});
          
          // Actualizar historial
          updateHistory(data.history || []);
          
          // Procesar log si hay uno nuevo
          const logLine = data.log_line || data.status_raw || '';
          const newHash = logLine ? btoa(encodeURIComponent(logLine)) : '';
          
          if (newHash !== lastLogHash) {
            lastLogHash = newHash;
            
            if (logLine) {
              console.log('Nuevo log:', logLine);
              const logData = parseLogLine(logLine);
              
              // Actualizar estadÃ­sticas
              $('#stat-frames').text(logData.frames);
              $('#stat-fps').text(logData.fps);
              $('#stat-time').text(logData.time);
              $('#stat-bitrate').text(logData.bitrate);
              $('#stat-speed').text(logData.speed);
              
              // Actualizar icono de estado
              updateStatusIcon(logLine);
            }
          }
          
          // Actualizar estado de procesamiento
          isProcessing = data.processing_active || data.current_step > 0;
          
        } catch (err) {
          console.error('Error procesando respuesta:', err);
        }
      })
      .fail(function(xhr, status, error) {
        console.error('Error obteniendo estado:', error);
      });
  }

  function updateSteps(step) {
    $('.pipeline-step').removeClass('active completed').addClass('inactive');
    
    for (let i = 1; i < step; i++) {
      $('#step' + i).removeClass('inactive').addClass('completed');
    }
    
    if (step > 0 && step <= 4) {
      $('#step' + step).removeClass('inactive').addClass('active');
    }
  }

  function updateVideoInfo(info) {
    if (!info || Object.keys(info).length === 0) return;
    
    // Formatear duraciÃ³n
    let durationFormatted = 'â€“';
    if (info.duration) {
      const match = info.duration.match(/(\d+(?:\.\d+)?)/);
      if (match) {
        const totalSeconds = parseInt(match[1]);
        const hours = Math.floor(totalSeconds / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        const seconds = totalSeconds % 60;
        durationFormatted = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
      }
    }
    
    $('#info-duration').text(durationFormatted);
    $('#info-name').text(info.name || 'â€“');
    $('#info-resolution').text(info.resolution || 'â€“');
    $('#info-format').text(info.formats || 'â€“');
    $('#info-vcodec').text(info.vcodec || 'â€“');
    $('#info-acodec').text(info.acodec || 'â€“');
    $('#info-size').text(info.size || 'â€“');
  }

  function updateHistory(history) {
    $('#history').empty();
    if (!Array.isArray(history) || history.length === 0) {
      $('#history').append('<tr><td colspan="2" class="text-center">Sin historial</td></tr>');
      return;
    }
    
    history.forEach(item => {
      let name = 'Desconocido';
      let status = 'Completado';
      
      if (typeof item === 'object') {
        name = item.name || item.file || 'Desconocido';
        status = item.status || item.message || 'Completado';
      }
      
      const statusClass = status.toLowerCase().includes('error') ? 'status-error' : 'status-success';
      
      $('#history').append(`
        <tr>
          <td>${name}</td>
          <td class="${statusClass}">${status}</td>
        </tr>
      `);
    });
  }

  function updateStatusIcon(logLine) {
    const icon = $('#statusIcon');
    if (!logLine) {
      icon.text('ğŸŸ¡');
      return;
    }
    
    const line = logLine.toLowerCase();
    
    if (line.includes('error') || line.includes('failed')) {
      icon.text('ğŸ”´');
    } else if (line.includes('progress=100%') || line.includes('completado')) {
      icon.text('âœ…');
    } else if (line.includes('time=') || line.includes('progress=')) {
      icon.text('ğŸŸ¢');
    } else {
      icon.text('ğŸŸ¡');
    }
  }

  // Actualizar cada segundo
  setInterval(updateStatus, 1000);
  
  // Actualizar inmediatamente
  updateStatus();
});
</script>
</body> 
</html>

